@if (!cargando && !sesionIniciada) {
  <p class="text-gray-500">Iniciá sesión para ver tu perfil</p>
} @else if (sesionIniciada()) {
  <section class="max-w-7xl mx-auto px-4 md:px-6 py-8 font-body" aria-labelledby="perfil-titulo">

    <!-- Datos principales -->
    <section class="grid md:grid-cols-[1fr_340px] gap-6 md:gap-8 items-start">
      <div class="flex items-start gap-4 md:gap-6">

        <!-- Foto de perfil con overlay -->
        <div class="relative group w-24 h-24 md:w-28 md:h-28">
          <img [src]="usuario()?.imagen_url || 'assets/usuario.png'" alt="Foto de perfil de {{ usuario()?.nombre }}"
            class="w-full h-full rounded-full object-cover ring-2 ring-white shadow-sm" />

          <!-- Overlay con ícono de lápiz -->
          <label for="fileInput" class="absolute inset-0 flex items-center justify-center 
          bg-[rgba(0,0,0,0.40)] rounded-full 
            opacity-0 group-hover:opacity-100 
            cursor-pointer transition">
            <!-- Ícono lápiz -->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="white"
              class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M16.862 3.487a2.25 2.25 0 013.182 3.182l-9.84 9.84a4.5 4.5 0 01-1.591 1.05l-3.337 1.112a.75.75 0 01-.949-.949l1.112-3.337a4.5 4.5 0 011.05-1.591l9.84-9.84z" />
            </svg>
          </label>

          <!-- Input de archivo oculto -->
          <input id="fileInput" type="file" accept="image/*" class="hidden" (change)="onFileSelected($event)" />
        </div>

        <!-- Nombre y email -->
        <div>
          <h1 class="text-2xl font-extrabold text-gray-900">{{ usuario()?.nombre }}</h1>
          <a [href]="'mailto:' + usuario()?.email" class="text-secondary underline underline-offset-2">
            {{ usuario()?.email }}
          </a>

          <!-- Link a paquetes -->
          <div class="mt-4">
            <a routerLink="/paquetes"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-secondary text-white shadow-sm hover:brightness-105 active:scale-95 transition">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="w-5 h-5" fill="currentColor">
                <path
                  d="M348 62.7C330.7 52.7 309.3 52.7 292 62.7L207.8 111.3C190.5 121.3 179.8 139.8 179.8 159.8L179.8 261.7L91.5 312.7C74.2 322.7 63.5 341.2 63.5 361.2L63.5 458.5C63.5 478.5 74.2 497 91.5 507L175.8 555.6C193.1 565.6 214.5 565.6 231.8 555.6L320.1 504.6L408.4 555.6C425.7 565.6 447.1 565.6 464.4 555.6L548.5 507C565.8 497 576.5 478.5 576.5 458.5L576.5 361.2C576.5 341.2 565.8 322.7 548.5 312.7L460.2 261.7L460.2 159.8C460.2 139.8 449.5 121.3 432.2 111.3L348 62.7zM296 356.6L296 463.1L207.7 514.1C206.5 514.8 205.1 515.2 203.7 515.2L203.7 409.9L296 356.6zM527.4 357.2C528.1 358.4 528.5 359.8 528.5 361.2L528.5 458.5C528.5 461.4 527 464 524.5 465.4L440.2 514C439 514.7 437.6 515.1 436.2 515.1L436.2 409.8L527.4 357.2zM412.3 159.8L412.3 261.7L320 315L320 208.5L411.2 155.9C411.9 157.1 412.3 158.5 412.3 159.9z" />
              </svg>
              <span>Mis paquetes</span>
            </a>
          </div>
        </div>
      </div>

      <!-- Mensaje lateral -->
      <aside class="rounded-xl bg-gradient-to-br from-primary to-gray-300 text-white p-5 shadow-sm">
        <p class="font-semibold"> Completá tu información así te podemos hacer llegar tus productos </p>
      </aside>
    </section>

    <!-- Formulario Dirección + Teléfono + Fecha Nac -->
    <form class="mt-6 grid gap-6 md:grid-cols-2" [formGroup]="form" (ngSubmit)="submit()">

      <!-- Teléfono -->
      <div>
        <label class="block mb-1 font-medium">
          Teléfono <span class="text-red-500">*</span>
        </label>
        <input formControlName="telefono" type="text" class="form-control" />
        @if (form.get('telefono')?.invalid && form.get('telefono')?.touched) {
          <p class="text-sm text-red-500 italic">
            El teléfono es obligatorio
          </p>
        }
      </div>

      <!-- Fecha de nacimiento -->
      <div>
        <label class="block mb-1 font-medium">
          Fecha de nacimiento <span class="text-red-500">*</span>
        </label>
        <input formControlName="fecha_nac" type="date" class="form-control" />
        @if (form.get('fecha_nac')?.invalid && form.get('fecha_nac')?.touched) {
          <p class="text-sm text-red-500 italic">
            La fecha de nacimiento es obligatoria
          </p>
        }
      </div>

      <!-- Localidad -->
      <div>
        <label class="block mb-1 font-medium">Localidad</label>
        <div class="relative">
          <select formControlName="localidad" (change)="onLocalidadChange($event)"
            class="form-control appearance-none pr-10">
            <option value="">Seleccione localidad</option>
            @for (loc of localidades(); track loc.id_localidad) {
              <option [value]="loc.id_localidad">{{ loc.nombre }}</option>
            }
          </select>
          <!-- Flecha custom -->
          <svg class="w-5 h-5 text-gray-500 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none" fill="none"
            stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </div>

      <!-- Código Postal -->
      <div>
        <label class="block mb-1 font-medium">Código postal</label>
        <input formControlName="cp" [value]="cpSeleccionado()" readonly class="form-control form-control--disabled" />
      </div>

      <!-- Calle -->
      <div>
        <label class="block mb-1 font-medium">Calle</label>
        <input formControlName="calle" type="text" class="form-control" />
        @if (!usuario()?.direccion?.calle) {
          <p class="text-sm text-gray-400 italic">No cargaste tu calle</p>
        }
      </div>

      <!-- Número -->
      <div>
        <label class="block mb-1 font-medium">Número</label>
        <input formControlName="numero" type="text" class="form-control" />
        @if (!usuario()?.direccion?.numero) {
          <p class="text-sm text-gray-400 italic">No cargaste tu número de calle</p>
        }
      </div>

      <!-- Dpto -->
      <div>
        <label class="block mb-1 font-medium">Dpto</label>
        <input formControlName="dpto" type="text" class="form-control"
          [value]="usuario()?.direccion?.departamento || ''" />
        @if (!usuario()?.direccion?.departamento) {
          <p class="text-sm text-gray-400 italic">No cargaste el departamento</p>
        }
      </div>

      <!-- Piso -->
      <div>
        <label class="block mb-1 font-medium">Piso</label>
        <input formControlName="piso" type="text" class="form-control" [value]="usuario()?.direccion?.piso || ''" />
        @if (!usuario()?.direccion?.piso) {
          <p class="text-sm text-gray-400 italic">No cargaste el piso</p>
        }
      </div>

      <!-- Botón guardar -->
      <div class="md:col-span-2 flex justify-end">
        <button
          type="submit"
          [disabled]="!tieneCambios()"
          [ngClass]="{
            'bg-gray-300 text-gray-500 cursor-not-allowed': !tieneCambios(),
            'bg-yellow-400 text-black cursor-pointer hover:brightness-105 active:translate-y-px': tieneCambios()
          }"
          class="inline-flex items-center justify-center px-6 py-3 rounded-xl font-medium shadow transition"
        >
          Guardar
        </button>
      </div>
    </form>
  </section>
}
